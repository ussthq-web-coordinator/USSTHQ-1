<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Site Migration Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: 'Arial', sans-serif; background:#f9f9f9; }
.card { margin-bottom: 1rem; }
.card-body { text-align:center; }
.card-title { font-size:1rem; font-weight:bold; }
.progress { height: 1.5rem; margin-bottom: 1rem; }
.card-text { font-size:0.9rem; }
.chart-container { margin-bottom:1rem; }
.tabulator { font-size:0.85rem; }
.tabulator .tabulator-header { background-color: #2c3e50; color: #fff; font-weight:bold; }
.modal-body table { width:100%; }
.modal-body td { padding:0.25rem; vertical-align:top; font-size:0.85rem; }
.table-header-links { font-size:1rem; margin-left:1rem; }
</style>
</head>
<body>
<div class="container-fluid my-3">

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Site Migration Dashboard</h3>
  <div>
    <a href="https://metrositesreport.usscommunications.org/" target="_blank" class="table-header-links">DHQ/AC Report ðŸ“„</a>
    <a href="http://corpssitesreport.usscommunications.org/" target="_blank" class="table-header-links">Corps Report ðŸ“„</a>
  </div>
</div>

<!-- Filters -->
<div class="row mb-3">
  <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
    <label>Division</label>
    <select id="filterDivision" class="form-select"></select>
  </div>
  <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
    <label>Area Command</label>
    <select id="filterAC" class="form-select"></select>
  </div>
  <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
    <label>Status</label>
    <select id="filterStatus" class="form-select"></select>
  </div>
  <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
    <label>Page Type</label>
    <select id="filterPageType" class="form-select"></select>
  </div>
  <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
    <label>Published Symphony</label>
    <select id="filterPubSym" class="form-select"></select>
  </div>
  <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
    <label>Symphony Site Type</label>
    <select id="filterSymType" class="form-select"></select>
  </div>
</div>

<!-- Metric Cards -->
<div class="row" id="metricCards"></div>

<!-- Overall Progress -->
<div class="row mb-3">
  <div class="col-12">
    <label>Overall Progress</label>
    <div class="progress">
      <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="row">
  <div class="col-lg-3 col-md-6 col-sm-12 chart-container">
    <canvas id="statusChart"></canvas>
  </div>
  <div class="col-lg-3 col-md-6 col-sm-12 chart-container">
    <canvas id="priorityChart"></canvas>
  </div>
  <div class="col-lg-3 col-md-6 col-sm-12 chart-container">
    <canvas id="pageTypeChart"></canvas>
  </div>
  <div class="col-lg-3 col-md-6 col-sm-12 chart-container">
    <canvas id="pubSymChart"></canvas>
  </div>
</div>

<!-- Table Instructions -->
<div class="mb-2"><small>Click a title to view page details.</small></div>

<!-- Table -->
<div id="table"></div>
</div>

<!-- Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>
</div>

<script>
const jsonURL = "https://cdn.jsdelivr.net/gh/ussthq-web-coordinator/USSTHQ-1@latest/DashboardData-a.json";
let table, tableData=[], charts={};

async function fetchData(){
  try{
    const res = await fetch(jsonURL);
    if(!res.ok) throw new Error('Unable to load JSON data');
    tableData = await res.json();
    initFilters();
    updateDashboard();
  }catch(err){
    document.body.innerHTML = `<div class="alert alert-danger m-3">Error loading dashboard: ${err.message}</div>`;
    console.error(err);
  }
}

function initFilters(){
  const filters = {
    filterDivision: [...new Set(tableData.map(d=>d.Division||"Not Set"))].sort(),
    filterAC: [...new Set(tableData.map(d=>d["Area Command Admin Group.title"]||"Not Set"))].sort(),
    filterStatus: [...new Set(tableData.map(d=>d.Status||"Not Set"))].sort(),
    filterPageType: [...new Set(tableData.map(d=>d["Page Type"]||"Not Set"))].sort(),
    filterPubSym: [...new Set(tableData.map(d=>d["Published Symphony"]||"Not Set"))].sort(),
    filterSymType: [...new Set(tableData.map(d=>d["Symphony Site Type"]||"Not Set"))].sort()
  };
  for(const id in filters){
    const sel = document.getElementById(id);
    sel.innerHTML = "<option value=''>All</option>"+filters[id].map(f=>`<option value="${f}">${f}</option>`).join("");
    sel.addEventListener("change", updateDashboard);
  }
}

function getFilteredData(){
  const div = document.getElementById("filterDivision").value;
  const ac = document.getElementById("filterAC").value;
  const status = document.getElementById("filterStatus").value;
  const pageType = document.getElementById("filterPageType").value;
  const pubSym = document.getElementById("filterPubSym").value;
  const symType = document.getElementById("filterSymType").value;

  return tableData.filter(d => 
    (!div || d.Division===div) &&
    (!ac || d["Area Command Admin Group.title"]===ac) &&
    (!status || d.Status===status) &&
    (!pageType || d["Page Type"]===pageType) &&
    (!pubSym || d["Published Symphony"]===pubSym) &&
    (!symType || d["Symphony Site Type"]===symType)
  );
}

// Metric cards and progress bar
function renderCards(){
  const filtered = getFilteredData();
  const today = new Date();
  const lastMonth = new Date(today.getFullYear(), today.getMonth()-1, today.getDate());

  const metrics = {
    "Total Pages": filtered.length,
    "Completed": filtered.filter(d=>["4","5"].some(s=>d.Status?.trim().startsWith(s))).length,
    "Do Not Migrate": filtered.filter(d=>d.Status?.trim()==="Do Not Migrate").length,
    "Modified Last Month": filtered.filter(d=>d.Modified && new Date(d.Modified)>=lastMonth).length,
    "Modified This Month": filtered.filter(d=>d.Modified && new Date(d.Modified).getMonth()===today.getMonth() && new Date(d.Modified).getFullYear()===today.getFullYear()).length,
    "AC QA": filtered.filter(d=>d.Status?.trim().startsWith("3a")).length,
    "DHQ QA": filtered.filter(d=>d.Status?.trim().startsWith("3b")).length,
    "THQ QA": filtered.filter(d=>d.Status?.trim().startsWith("3c")).length
  };

  const colors = ['#e74c3c','#f39c12','#f1c40f','#2ecc71','#3498db','#9b59b6','#16a085','#d35400'];
  const container = document.getElementById("metricCards");
  container.innerHTML = "";
  let i=0;
  for(const key in metrics){
    container.innerHTML += `
      <div class="col-lg-3 col-md-6 col-sm-12">
        <div class="card text-white" style="background-color:${colors[i++ % colors.length]}">
          <div class="card-body">
            <h5 class="card-title">${key}</h5>
            <p class="card-text">${metrics[key]}</p>
          </div>
        </div>
      </div>`;
  }

  // Overall progress: Completed + Do Not Migrate
  const progress = metrics["Total Pages"] 
      ? Math.round((metrics["Completed"] + metrics["Do Not Migrate"]) / metrics["Total Pages"] * 100) 
      : 0;
  const progressBar = document.getElementById("progressBar");
  progressBar.style.width = progress+"%";
  progressBar.innerText = progress+"%";
}

// Chart rendering with percentages and hover guidance
function renderCharts(){
  const filtered = getFilteredData();

  const statusGroups = {
    "Do Not Migrate":["Do Not Migrate"],
    "Migration Not Started":["1a","1b"],
    "Content Migration":["2a","2b","2c"],
    "QA":["3a","3b","3c"],
    "THQ QA Complete":["4"],
    "Published":["5"]
  };

  const statusCounts = {};
  Object.keys(statusGroups).forEach(k=>statusCounts[k]=0);
  filtered.forEach(d=>{
    const s = d.Status ? d.Status.trim() : "";
    for(const group in statusGroups){
      if(statusGroups[group].some(code => s.startsWith(code))){
        statusCounts[group]++;
        break;
      }
    }
  });

  const totalStatus = Object.values(statusCounts).reduce((a,b)=>a+b,0);
  const statusLabels = Object.keys(statusCounts).map(k=>`${k} (${totalStatus?Math.round(statusCounts[k]/totalStatus*100)+"%":"0%"})`);
  const statusData = Object.values(statusCounts);

  const makePie = (ctx, labels, data, title)=>{
    return new Chart(ctx,{
      type:'pie',
      data:{labels, datasets:[{data, backgroundColor:['#e74c3c','#f39c12','#f1c40f','#2ecc71','#3498db','#9b59b6']}]},
      options:{
        responsive:true,
        plugins:{
          legend:{display:true, position:'bottom', labels:{generateLabels:chart => labels.map((l,i)=>({text:l, fillStyle:chart.data.datasets[0].backgroundColor[i]}))}},
          title:{display:true,text:title},
          tooltip:{
            callbacks:{
              label:function(context){
                const count = context.raw;
                const total = context.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                const percent = total ? ((count/total)*100).toFixed(1) : 0;
                return `${context.label.split(' (')[0]}: ${count} pages (${percent}%)`;
              }
            }
          }
        }
      }
    });
  };

  if(charts.statusChart) charts.statusChart.destroy();
  charts.statusChart = makePie(document.getElementById("statusChart"), statusLabels, statusData, "Status");

  const chartData = field=>{
    const counts={};
    filtered.forEach(d=>{
      const v = d[field]||"Not Set";
      counts[v] = (counts[v]||0)+1;
    });
    return counts;
  };

  ["priorityChart","pageTypeChart","pubSymChart"].forEach((id,idx)=>{
    if(charts[id]) charts[id].destroy();
    const counts = chartData(id==="priorityChart"?"Priority":id==="pageTypeChart"?"Page Type":"Published Symphony");
    const labels = Object.keys(counts).map(k=>`${k} (${Math.round(counts[k]/filtered.length*100)}%)`);
    charts[id] = makePie(document.getElementById(id), labels, Object.values(counts), id==="priorityChart"?"Priority":id==="pageTypeChart"?"Page Type":"Published Symphony");
  });
}

// Table
function renderTable(){
  if(table) table.destroy();
  const filtered = getFilteredData();
  table = new Tabulator("#table",{
    data: filtered,
    layout:"fitDataStretch",
    responsiveLayout:"collapse",
    placeholder:"No matching pages found",
    columns:[
      {title:"Title", field:"Title", formatter:"plaintext", cellClick:(e,cell)=>showModal(cell.getRow().getData())},
      {title:"SD", field:"Page URL", formatter:cell=>cell.getValue()?`<a href="${cell.getValue()}" target="_blank">&#128279;</a>`:""},
      {title:"ZD", field:"Zesty URL Path Part", formatter:cell=>cell.getValue()?`<a href="https://8hxvw8tw-dev.webengine.zesty.io${cell.getValue()}?zpw=tsasecret123&redirect=false&_bypassError=true" target="_blank">&#128279;</a>`:""},
      {title:"Status", field:"Status"},
      {title:"Priority", field:"Priority"},
      {title:"Effort Needed", field:"Effort Needed"},
      {title:"Published Symphony", field:"Published Symphony", formatter:cell=>cell.getValue()?"Yes":"No"},
      {title:"Page Type", field:"Page Type"},
      {title:"Modified", field:"Modified"},
      {title:"Site Title", field:"Site Title"}
    ],
    pagination:"local",
    paginationSize:20,
    movableColumns:true
  });
}

function showModal(data){
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  modalTitle.innerText = data.Title||"";
  let html = '<table class="table table-bordered">';
  for(const key in data){
    html+=`<tr><td><b>${key}</b></td><td>${data[key]}</td></tr>`;
  }
  html+='</table>';
  modalBody.innerHTML = html;
  const modal = new bootstrap.Modal(document.getElementById('detailModal'));
  modal.show();
}

function updateDashboard(){
  renderCards();
  renderCharts();
  renderTable();
}

fetchData();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
