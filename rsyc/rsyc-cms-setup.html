<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>RSYC CMS Publisher</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="rsyc-generator-v2.css">
    <style id="globalStyles">
        /* Global styles will be injected here on page load */
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header with CMS Controls -->
        <header class="minimal-header">
            <div class="header-main">
                <h6 class="app-title">üìã RSYC CMS Publisher</h6>
                
                <!-- Primary Controls -->
                <div class="primary-controls">
                    <button id="prevCenter" class="btn btn-sm btn-outline-secondary" title="Previous Center" disabled>
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <select id="centerSelect" class="center-dropdown-minimal">
                        <option value="">-- Select Center --</option>
                    </select>
                    <button id="refreshData" class="btn btn-sm btn-outline-secondary" title="Reload live JSON">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button id="nextCenter" class="btn btn-sm btn-outline-secondary" title="Next Center" disabled>
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>

                <!-- Toggle Button -->
                <button id="toggleAdvanced" class="btn-toggle" title="Show/Hide Embed Codes">
                    <i class="bi bi-chevron-down"></i> Embed Code
                </button>
            </div>
        </header>

        <!-- Two-Column Layout: Embed Codes (Left) + Live Preview (Right) -->
        <div class="cms-layout" style="display: flex; flex: 1; gap: 0; overflow: hidden;">
            <!-- Sidebar with Embed Codes (Fixed Width) -->
            <div class="cms-sidebar" style="width: 380px; border-right: 1px solid #e9ecef; display: flex; flex-direction: column; background: white;">
                <div style="padding: 16px; border-bottom: 1px solid #e9ecef;">
                    <h6 style="margin: 0 0 8px 0; color: #333; font-size: 13px; font-weight: 600;">
                        <i class="bi bi-code"></i> Embed Code Preview
                    </h6>
                    <p style="margin: 0; color: #666; font-size: 12px;">Copy the embed code below for your center</p>
                </div>
                
                <div style="flex: 1; overflow-y: auto; padding: 12px 16px;">
                    <!-- iFrame Option -->
                    <div id="code-iframe" class="code-section" style="margin-bottom: 16px;">
                        <p style="margin: 0 0 8px 0; color: #666; font-size: 12px; font-weight: 600;">üñºÔ∏è iFrame Embed:</p>
                        <textarea id="code-iframe-text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5; font-family: monospace; font-size: 10px; height: 80px; resize: vertical;" readonly spellcheck="false"></textarea>
                        <button class="code-copy-btn" data-textarea="code-iframe-text" style="width: 100%; margin-top: 6px; padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>

                    <!-- Div Mount Option -->
                    <div id="code-div" class="code-section" style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #e9ecef;">
                        <p style="margin: 0 0 8px 0; color: #666; font-size: 12px; font-weight: 600;">üì¶ Div Mount (API):</p>
                        <textarea id="code-div-text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5; font-family: monospace; font-size: 10px; height: 100px; resize: vertical;" readonly spellcheck="false"></textarea>
                        <button class="code-copy-btn" data-textarea="code-div-text" style="width: 100%; margin-top: 6px; padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>

                    <!-- Script Injection Option -->
                    <div id="code-script" class="code-section">
                        <p style="margin: 0 0 8px 0; color: #666; font-size: 12px; font-weight: 600;">‚ö° Auto-Inject:</p>
                        <textarea id="code-script-text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5; font-family: monospace; font-size: 10px; height: 80px; resize: vertical;" readonly spellcheck="false"></textarea>
                        <button class="code-copy-btn" data-textarea="code-script-text" style="width: 100%; margin-top: 6px; padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
            </div>

            <!-- Live Preview (Full-Screen) -->
            <div class="cms-preview" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div class="preview-header-minimal" style="padding: 12px 16px; border-bottom: 1px solid #e9ecef; background: white;">
                    <h6 style="margin: 0; display: flex; align-items: center; gap: 8px; color: #333;"><i class="bi bi-eye"></i> Live Preview</h6>
                    <span class="preview-status" id="previewStatus" style="margin-top: 4px; font-size: 12px; color: #666;">Select a center to begin</span>
                </div>
                <div class="preview-container-fullscreen" id="livePreview" style="flex: 1; overflow-y: auto; background: white;">
                    <div class="preview-placeholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #999;">
                        <div class="placeholder-icon" style="font-size: 48px; margin-bottom: 16px;">üëÜ</div>
                        <p style="margin: 0; font-size: 14px;">Select a center above to see the live preview</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Minimal Status Bar -->
        <footer class="status-bar-minimal">
            <span id="dataStatus">Data: Loading...</span>
            <span id="selectedCenter">Selected: None</span>
            <span id="lastGenerated">Last Generated: Never</span>
        </footer>

        <!-- Error Banner -->
        <div id="rsyc-error-banner" style="display:none; position:fixed; bottom:16px; left:16px; right:16px; background:#ffe6e6; color:#990000; border:1px solid #ffcccc; padding:12px 16px; border-radius:6px; z-index:11000; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
            <strong>RSYC Error:</strong>
            <span id="rsyc-error-text" style="margin-left:8px;">An error occurred. Check console for details.</span>
            <button id="rsyc-error-close" style="float:right; background:transparent; border:none; font-weight:700; color:#990000; cursor:pointer;">‚úñ</button>
        </div>
    </div>

    <!-- Scripts - Only data layer, NOT the full generator -->
    <script src="rsyc-data.js"></script>
    <script src="rsyc-staff-order.js"></script>
    <script src="rsyc-templates.js"></script>
    <script src="rsyc-tracker.js"></script>

    <!-- CMS-Specific Script -->
    <script>
        /**
         * RSYC CMS Setup - Uses same infrastructure as profile-publisher
         * Generates embed codes and live preview from API
         */
        class RSYCCMSSetup {
            constructor() {
                this.dataLoader = null;
                this.templateEngine = null;
                this.currentCenter = null;
                this.currentCenterIndex = 0;
                this.centers = [];
                this.init();
            }

            async init() {
                try {
                    // Initialize components (same as generator v2)
                    this.dataLoader = new RSYCDataLoader();
                    this.templateEngine = new RSYCTemplates();

                    // Inject global styles and load custom styles (same as generator v2)
                    this.injectGlobalStyles();
                    await this.loadCustomStyles();

                    // Load data
                    this.updateStatus('dataStatus', 'Data: Loading...');
                    await this.dataLoader.loadAll();
                    
                    // Get centers list from cache (same as profile-publisher)
                    this.centers = this.dataLoader.cache.centers || [];
                    
                    // Populate dropdown
                    this.populateCenterDropdown();
                    
                    this.setupEventListeners();
                    
                    // Load last selected center or first center
                    this.loadLastSelectedCenter();
                    
                    this.updateStatus('dataStatus', `Data: Ready (${this.centers.length} centers)`);
                } catch (error) {
                    console.error('CMS Setup Init Error:', error);
                    this.showError('Failed to initialize. Check console for details.');
                }
            }

            injectGlobalStyles() {
                // Inject global CSS into the page (same as generator v2)
                const styleElement = document.getElementById('globalStyles');
                if (styleElement) {
                    styleElement.textContent = this.getGlobalCSS();
                }
            }

            async loadCustomStyles() {
                // Load custom styles from rsyc-custom-styles.html (same as generator v2)
                try {
                    const response = await fetch('rsyc-custom-styles.html');
                    if (response.ok) {
                        const customStylesContent = await response.text();
                        
                        // Inject into page head for global styling
                        if (!document.getElementById('rsyc-global-styles')) {
                            const styleContainer = document.createElement('div');
                            styleContainer.id = 'rsyc-global-styles';
                            styleContainer.innerHTML = customStylesContent;
                            document.head.appendChild(styleContainer);
                        }
                        
                        console.log('‚úÖ Custom styles loaded');
                    } else {
                        console.warn('‚ö†Ô∏è Custom styles file not found, using defaults');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to load custom styles:', error);
                }
            }

            getGlobalCSS() {
                // Return global CSS (same as generator v2)
                const version = "1.0.0";
                const lastUpdated = "2025-11-15";
                
                return `/* ========================================
   RSYC Profile - Global CSS for CMS
   Version: ${version}
   Last Updated: ${lastUpdated}
   
   This CSS is required for RSYC profiles to work correctly.
   ======================================== */

/* TOOLTIP STYLES */
.tooltip-icon { 
    position: relative; 
    display: inline-flex; 
    align-items: center; 
    cursor: help; 
    margin-left: 6px; 
}

.tooltip-text {
    visibility: hidden;
    background-color: #333;
    color: #fff;
    text-align: center;
    padding: 6px 10px;
    border-radius: 4px;
    position: absolute;
    z-index: 1000;
    bottom: 125%;
    left: 50%;
    margin-left: -50px;
    opacity: 0;
    transition: opacity 0.3s;
    width: 120px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
}

.tooltip-icon:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

/* HORIZONTAL SCROLL STYLING */
.horizontal-scroll {
    display: flex;
    gap: 16px;
    overflow-x: auto;
    padding-bottom: 8px;
    scroll-behavior: smooth;
}

.horizontal-scroll::-webkit-scrollbar {
    height: 6px;
}

.horizontal-scroll::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.horizontal-scroll::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.horizontal-scroll::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* SCHEDULE CARD STYLES */
.schedule-card {
    background: white;
    color: #333;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    min-width: 280px;
    flex-shrink: 0;
    padding: 16px;
}

/* STAFF BIO STYLES */
.staff-bio {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    font-size: 13px;
    line-height: 1.5;
    color: #666;
    margin: 8px 0 0 0;
}

/* MODAL STYLES */
.rsyc-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    overflow: auto;
}

.rsyc-modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.rsyc-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e0e0e0;
}

.rsyc-modal-header h3 {
    margin: 0;
    font-size: 20px;
    color: #333;
}

.rsyc-modal-close {
    font-size: 24px;
    color: #999;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.rsyc-modal-close:hover {
    color: #333;
}`;
            }

            populateCenterDropdown() {
                const select = document.getElementById('centerSelect');
                if (!select) return;

                select.innerHTML = '<option value="">-- Select Center --</option>';
                this.centers.forEach((center, index) => {
                    const option = document.createElement('option');
                    option.value = center.Id;
                    option.textContent = `${center.name} (${center.city}, ${center.state})`;
                    option.dataset.index = index;
                    select.appendChild(option);
                });
            }

            setupEventListeners() {
                // Center selection
                const centerSelect = document.getElementById('centerSelect');
                if (centerSelect) {
                    centerSelect.addEventListener('change', (e) => {
                        if (e.target.value) {
                            const index = Array.from(e.target.options).findIndex(opt => opt.value === e.target.value);
                            if (index > 0) {
                                this.selectCenter(index - 1);
                            }
                        }
                    });
                    
                    // Arrow key navigation without opening dropdown
                    centerSelect.addEventListener('keydown', (e) => {
                        if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            this.previousCenter();
                        } else if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            this.nextCenter();
                        }
                    });
                }

                // Navigation
                const prevBtn = document.getElementById('prevCenter');
                const nextBtn = document.getElementById('nextCenter');
                const refreshBtn = document.getElementById('refreshData');
                const toggleBtn = document.getElementById('toggleAdvanced');
                const errorCloseBtn = document.getElementById('rsyc-error-close');

                if (prevBtn) prevBtn.addEventListener('click', () => this.previousCenter());
                if (nextBtn) nextBtn.addEventListener('click', () => this.nextCenter());
                if (refreshBtn) refreshBtn.addEventListener('click', () => this.refreshData());

                // Individual copy buttons for each code section
                document.querySelectorAll('.code-copy-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const textareaId = e.target.closest('button').dataset.textarea;
                        const textarea = document.getElementById(textareaId);
                        if (textarea) {
                            navigator.clipboard.writeText(textarea.value).then(() => {
                                const originalText = btn.innerHTML;
                                btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
                                btn.style.background = '#20c997';
                                setTimeout(() => {
                                    btn.innerHTML = originalText;
                                    btn.style.background = '#28a745';
                                }, 2000);
                            });
                        }
                    });
                });
                // Toggle advanced controls (for future use)
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => {
                        const toggleIcon = toggleBtn.querySelector('i');
                        if (toggleIcon) {
                            toggleIcon.classList.toggle('bi-chevron-down');
                            toggleIcon.classList.toggle('bi-chevron-up');
                        }
                    });
                }

                // Error close
                if (errorCloseBtn) {
                    errorCloseBtn.addEventListener('click', () => {
                        const banner = document.getElementById('rsyc-error-banner');
                        if (banner) banner.style.display = 'none';
                    });
                }
            }

            selectCenter(index) {
                if (index < 0 || index >= this.centers.length) return;

                this.currentCenterIndex = index;
                this.currentCenter = this.centers[index];

                // Save to localStorage for persistence
                localStorage.setItem('rsycSelectedCenterId', this.currentCenter.Id);
                localStorage.setItem('rsycSelectedCenterIndex', index);

                // Update dropdown
                const select = document.getElementById('centerSelect');
                if (select) select.value = this.currentCenter.Id;

                // Update navigation buttons with null checks
                const prevBtn = document.getElementById('prevCenter');
                const nextBtn = document.getElementById('nextCenter');
                if (prevBtn) prevBtn.disabled = index === 0;
                if (nextBtn) nextBtn.disabled = index === this.centers.length - 1;

                // Update selected center display
                this.updateStatus('selectedCenter', `Selected: ${this.currentCenter.name}`);

                // Generate preview and embed codes
                this.generatePreview();
                this.generateEmbedCodes();
            }

            loadLastSelectedCenter() {
                // Try to restore last selected center from localStorage
                const lastCenterId = localStorage.getItem('rsycSelectedCenterId');
                const lastCenterIndex = localStorage.getItem('rsycSelectedCenterIndex');

                if (lastCenterId && lastCenterIndex) {
                    const index = parseInt(lastCenterIndex);
                    if (index >= 0 && index < this.centers.length && this.centers[index].Id === lastCenterId) {
                        this.selectCenter(index);
                        return;
                    }
                }

                // Fall back to first center if no saved selection or it's invalid
                if (this.centers.length > 0) {
                    this.selectCenter(0);
                }
            }

            previousCenter() {
                if (this.currentCenterIndex > 0) {
                    this.selectCenter(this.currentCenterIndex - 1);
                }
            }

            nextCenter() {
                if (this.currentCenterIndex < this.centers.length - 1) {
                    this.selectCenter(this.currentCenterIndex + 1);
                }
            }

            async generatePreview() {
                try {
                    this.updateStatus('previewStatus', 'Generating preview...');

                    // Get center data (same as profile-publisher)
                    const centerData = await this.dataLoader.getCenterData(this.currentCenter.Id);

                    // Generate HTML for all sections using templateEngine (same as profile-publisher)
                    let html = '';
                    const sections = ['schedules', 'hours', 'facilities', 'programs', 'staff', 'nearby', 'volunteer', 'footerPhoto', 'contact'];
                    
                    sections.forEach(sectionId => {
                        try {
                            const sectionHTML = this.templateEngine.generateSection(sectionId, centerData);
                            if (sectionHTML) {
                                html += sectionHTML + '\n\n';
                            }
                        } catch (e) {
                            console.warn(`Error generating section ${sectionId}:`, e);
                        }
                    });

                    // Inject into preview
                    const preview = document.getElementById('livePreview');
                    preview.innerHTML = html;

                    // Initialize any modals or interactive elements in the preview
                    this.attachPreviewEventListeners(preview);

                    this.updateStatus('previewStatus', 'Preview loaded');
                    this.updateStatus('lastGenerated', `Last Generated: ${new Date().toLocaleTimeString()}`);
                } catch (error) {
                    console.error('Generate Preview Error:', error);
                    this.showError(`Failed to generate preview: ${error.message}`);
                }
            }

            attachPreviewEventListeners(previewContainer) {
                if (!previewContainer) return;

                // Override showRSYCModal and closeRSYCModal to work within preview
                window.showRSYCModal = (type, centerName) => {
                    const modal = previewContainer.querySelector('#rsyc-modal-' + type);
                    if (modal) {
                        modal.style.display = 'flex';
                    }
                };

                window.closeRSYCModal = (type) => {
                    const modal = previewContainer.querySelector('#rsyc-modal-' + type);
                    if (modal) {
                        modal.style.display = 'none';
                    }
                };

                // Attach modal functionality
                const viewAllButtons = previewContainer.querySelectorAll('.view-all-btn');
                viewAllButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const modalId = btn.getAttribute('data-modal');
                        const modal = previewContainer.querySelector(`#${modalId}`);
                        if (modal) {
                            modal.style.display = 'block';
                        }
                    });
                });

                // Attach close button functionality
                const closeButtons = previewContainer.querySelectorAll('.rsyc-modal-close');
                closeButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const modal = btn.closest('.rsyc-modal');
                        if (modal) {
                            modal.style.display = 'none';
                        }
                    });
                });

                // Close modal when clicking outside
                const modals = previewContainer.querySelectorAll('.rsyc-modal');
                modals.forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });

                // Scroll to top
                previewContainer.scrollTop = 0;
            }

            generateEmbedCodes() {
                const centerId = this.currentCenter.Id;
                const centerName = this.currentCenter.name;
                
                // Use development localhost or production domain
                const baseUrl = window.location.hostname === 'localhost' 
                    ? 'http://localhost:3001'
                    : 'https://thisishoperva.org';

                // iFrame embed - loads via rsyc-profile-publisher.html
                const iframeCode = `<iframe src="${baseUrl}/rsyc/rsyc-profile-publisher.html?centerId=${centerId}" width="100%" height="1200" frameborder="0" style="border: none; border-radius: 8px;"></iframe>`;

                // Div mount - loads via API + loader script
                const divCode = `<div id="rsyc-profile-${centerId}"></div>
<script src="${baseUrl}/rsyc/rsyc-profile-loader.js"><\/script>
<script>
  RSYCProfileLoader.load('${centerId}', 'rsyc-profile-${centerId}');
<\/script>`;

                // Script injection - auto-mounts to divs with data attribute
                const scriptCode = `<div data-rsyc-center-id="${centerId}"></div>
<script src="${baseUrl}/rsyc/rsyc-profile-injector.js"><\/script>`;

                // Populate textareas
                document.getElementById('code-iframe-text').value = iframeCode;
                document.getElementById('code-div-text').value = divCode;
                document.getElementById('code-script-text').value = scriptCode;
            }

            async refreshData() {
                try {
                    this.updateStatus('dataStatus', 'Data: Refreshing...');
                    this.dataLoader.clearCache();
                    await this.dataLoader.loadAll();
                    this.centers = this.dataLoader.cache.centers || [];
                    this.populateCenterDropdown();
                    this.updateStatus('dataStatus', `Data: Ready (${this.centers.length} centers)`);
                    if (this.currentCenter) {
                        this.generatePreview();
                    }
                } catch (error) {
                    console.error('Refresh Error:', error);
                    this.showError('Failed to refresh data');
                }
            }

            updateStatus(elementId, text) {
                const el = document.getElementById(elementId);
                if (el) el.textContent = text;
            }

            showError(message) {
                const banner = document.getElementById('rsyc-error-banner');
                const text = document.getElementById('rsyc-error-text');
                text.textContent = message;
                banner.style.display = 'block';
                setTimeout(() => {
                    banner.style.display = 'none';
                }, 5000);
            }
        }

        // Initialize CMS on page load
        document.addEventListener('DOMContentLoaded', () => {
            window.cmsSetup = new RSYCCMSSetup();
        });
    </script>
</body>
</html>
