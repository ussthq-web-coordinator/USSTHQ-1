<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Website Migration Dashboard</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { padding: 20px; font-family: Arial, sans-serif; }
    .card { margin-bottom: 15px; }
    .filter-label { font-weight: bold; margin-right: 10px; }
    .chart-container { position: relative; height:300px; width:100%; margin-bottom:30px; }
</style>
</head>
<body>

<h1 class="mb-4">Website Migration Dashboard</h1>

<!-- Filters -->
<div class="row mb-3">
    <div class="col-md-2 col-6 mb-2">
        <label class="filter-label">Division</label>
        <select id="divisionFilter" class="form-select"></select>
    </div>
    <div class="col-md-2 col-6 mb-2">
        <label class="filter-label">Area Command</label>
        <select id="acFilter" class="form-select"></select>
    </div>
    <div class="col-md-2 col-6 mb-2">
        <label class="filter-label">Status</label>
        <select id="statusFilter" class="form-select"></select>
    </div>
    <div class="col-md-2 col-6 mb-2">
        <label class="filter-label">Page Type</label>
        <select id="pageTypeFilter" class="form-select"></select>
    </div>
    <div class="col-md-2 col-6 mb-2">
        <label class="filter-label">Published Symphony</label>
        <select id="pubSymFilter" class="form-select"></select>
    </div>
    <div class="col-md-2 col-6 mb-2">
        <label class="filter-label">Symphony Site Type</label>
        <select id="symTypeFilter" class="form-select"></select>
    </div>
</div>

<!-- Metric Cards -->
<div class="row mb-4" id="metricCards">
    <div class="col-md-2 col-6">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">Completed</h5>
                <p class="card-text" id="completedCount">0</p>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <h5 class="card-title">Do Not Migrate</h5>
                <p class="card-text" id="dnmCount">0</p>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">Modified Last Month</h5>
                <p class="card-text" id="modLastMonth">0</p>
            </div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h5 class="card-title">Modified This Month</h5>
                <p class="card-text" id="modThisMonth">0</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-12">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">Division Progress</h5>
                <div class="progress">
                    <div id="divProgress" class="progress-bar" role="progressbar" style="width:0%">0%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row">
    <div class="col-md-6 col-12 chart-container">
        <h6>Status Distribution</h6>
        <canvas id="statusChart"></canvas>
    </div>
    <div class="col-md-6 col-12 chart-container">
        <h6>Priority Distribution</h6>
        <canvas id="priorityChart"></canvas>
    </div>
    <div class="col-md-6 col-12 chart-container">
        <h6>Page Type Distribution</h6>
        <canvas id="pageTypeChart"></canvas>
    </div>
    <div class="col-md-6 col-12 chart-container">
        <h6>Published Symphony Distribution</h6>
        <canvas id="pubSymChart"></canvas>
    </div>
</div>

<!-- Optional: Table -->
<div class="row mt-4">
    <div class="col-12" id="tableContainer"></div>
</div>

<script>
// Global variables
let fullData = [];
let charts = {};

// Load JSON and initialize
fetch('DashboardData.json')
  .then(res => res.json())
  .then(data => {
    fullData = data;
    initFilters();
    updateDashboard();
  });

// Initialize filters
function initFilters() {
    const filterIds = ['divisionFilter','acFilter','statusFilter','pageTypeFilter','pubSymFilter','symTypeFilter'];
    filterIds.forEach(fid => {
        const select = document.getElementById(fid);
        select.innerHTML = '<option value="">All</option>';
    });

    const getUnique = (key) => [...new Set(fullData.map(d=>d[key]||"Not Set"))].sort();

    // Populate each filter
    document.getElementById('divisionFilter').append(...getUnique('Division').map(v=>new Option(v,v)));
    document.getElementById('acFilter').append(...getUnique('Area Command Admin Group.title').map(v=>new Option(v,v)));
    document.getElementById('statusFilter').append(...getUnique('Status').map(v=>new Option(v,v)));
    document.getElementById('pageTypeFilter').append(...getUnique('Page Type').map(v=>new Option(v,v)));
    document.getElementById('pubSymFilter').append(...getUnique('Published Symphony').map(v=>new Option(v,v)));
    document.getElementById('symTypeFilter').append(...getUnique('Symphony Site Type').map(v=>new Option(v,v)));

    // Add onchange event
    filterIds.forEach(fid => document.getElementById(fid).addEventListener('change', updateDashboard));
}

// Filter data based on dropdowns
function getFilteredData() {
    let fData = [...fullData];
    const filters = {
        Division: document.getElementById('divisionFilter').value,
        'Area Command Admin Group.title': document.getElementById('acFilter').value,
        Status: document.getElementById('statusFilter').value,
        'Page Type': document.getElementById('pageTypeFilter').value,
        'Published Symphony': document.getElementById('pubSymFilter').value,
        'Symphony Site Type': document.getElementById('symTypeFilter').value
    };
    for (let key in filters) {
        if (filters[key]) fData = fData.filter(d => (d[key]||"Not Set") === filters[key]);
    }
    return fData;
}

// Update dashboard metrics and charts
function updateDashboard() {
    const data = getFilteredData();

    // Metric cards
    const completed = data.filter(d=>d.Status.startsWith("4") || d.Status.startsWith("5") || d.Status==="Do Not Migrate").length;
    const dnm = data.filter(d=>d.Status==="Do Not Migrate").length;
    const now = new Date();
    const modLastMonth = data.filter(d=>{
        const m = new Date(d.Modified);
        return m >= new Date(now.getFullYear(), now.getMonth()-1,1) && m < new Date(now.getFullYear(), now.getMonth(),1);
    }).length;
    const modThisMonth = data.filter(d=>{
        const m = new Date(d.Modified);
        return m >= new Date(now.getFullYear(), now.getMonth(),1);
    }).length;
    const progressPct = data.length ? Math.round(completed/data.length*100) : 0;

    document.getElementById('completedCount').innerText = completed;
    document.getElementById('dnmCount').innerText = dnm;
    document.getElementById('modLastMonth').innerText = modLastMonth;
    document.getElementById('modThisMonth').innerText = modThisMonth;
    const bar = document.getElementById('divProgress');
    bar.style.width = progressPct+'%';
    bar.innerText = progressPct+'%';

    // Charts
    renderPieChart('statusChart', 'Status', data);
    renderPieChart('priorityChart', 'Priority', data);
    renderPieChart('pageTypeChart', 'Page Type', data);
    renderPieChart('pubSymChart', 'Published Symphony', data);
}

// Generic pie chart renderer
function renderPieChart(canvasId, key, data) {
    const counts = {};
    data.forEach(d=>counts[d[key]||"Not Set"] = (counts[d[key]||"Not Set"]||0)+1);
    const ctx = document.getElementById(canvasId).getContext('2d');
    if(charts[canvasId]) charts[canvasId].destroy();
    charts[canvasId] = new Chart(ctx,{
        type:'pie',
        data:{labels:Object.keys(counts), datasets:[{data:Object.values(counts), backgroundColor:Object.keys(counts).map((_,i)=>`hsl(${i*60%360},70%,50%)`)}]},
        options:{plugins:{legend:{display:true,position:'bottom'}}}
    });
}
</script>

</body>
</html>
