<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Site Migration — Insights Dashboard</title>
<style>
  :root{
    --bg:#0f1724; --card:#101b2a; --muted:#8b99ae;
    --accent:#e03b2e; --accent-light:#ff7a66; --glass: rgba(255,255,255,0.03);
    --completed:#3cb371; --inprogress:#ffa500; --donot:#ff4500;
  }
  body{
    font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    background: linear-gradient(180deg,#071028 0%, #081426 100%);
    color: #dbe7f2; margin:0; padding:20px;
  }
  header{
    display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:20px;
  }
  h1{margin:0;font-size:22px;font-weight:700;}
  .controls{margin-left:auto; display:flex; gap:8px; flex-wrap:wrap;}
  #dataUrl{font-weight:600; color:#ffa;}
  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
    gap:16px;
  }
  .card{
    background: var(--card);
    padding:22px;
    border-radius:18px;
    box-shadow:0 10px 30px rgba(3,8,20,.6);
    min-height:200px;
    display:flex;
    flex-direction:column;
    justify-content:flex-start;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .card:hover{
    transform: translateY(-4px);
    box-shadow:0 16px 36px rgba(3,8,20,.8);
  }
  .card h3{margin:0 0 14px 0; font-size:18px;}
  .stat{font-weight:700; font-size:28px;}
  .muted{color:var(--muted); font-size:13px;}
  .small-list{
    list-style:none; padding:0; margin:10px 0 0 0; max-height:240px; overflow-y:auto;
  }
  .small-list li{
    padding:8px 0; border-bottom:1px dashed rgba(255,255,255,0.05);
    font-size:14px; transition: background 0.2s;
  }
  .small-list li:hover{ background: rgba(255,255,255,0.03); }
  .bar{
    height:16px; background:var(--glass); border-radius:10px;
    overflow:hidden; margin-top:14px;
  }
  .bar > i{
    display:block; height:16px; background: linear-gradient(90deg,var(--accent),var(--accent-light));
    width:0%;
    border-radius:10px;
    transition: width 0.6s ease;
  }
  .pill{
    display:inline-block; font-weight:600;
    padding:6px 14px; border-radius:999px; font-size:14px;
    margin-right:8px; margin-top:4px;
  }
  .completed{background:var(--completed); color:#fff;}
  .inprogress{background:var(--inprogress); color:#fff;}
  .donot{background:var(--donot); color:#fff;}
  table{
    border-collapse: separate;
    border-spacing:4px;
    width:100%;
    font-size:13px;
  }
  table th, table td{ padding:4px 8px; text-align:left; }
  table th{ color:var(--accent); font-weight:600; }
  button{
    background:#0b2230; border:1px solid rgba(255,255,255,0.05);
    color:#dbe7f2; padding:8px 14px; border-radius:10px; cursor:pointer;
    transition: background 0.2s, transform 0.1s;
  }
  button:hover{ background:#132f45; transform: translateY(-1px);}
  #refreshTime{margin-top:6px;font-size:13px;color:var(--muted);}
  @media (max-width:640px){
    header{flex-direction:column;align-items:flex-start;}
    .controls{margin-left:0;}
  }
</style>
</head>
<body>
<header>
  <div>
    <h1>Site Migration Insights Dashboard</h1>
    <div class="muted">Connected to: <span id="dataUrl">loading...</span></div>
  </div>
  <div class="controls">
    <select id="divisionFilter"><option value="">All Divisions</option></select>
    <button id="refreshBtn">Refresh</button>
    <button id="toggleCodeBtn">Show code</button>
    <button data-copy-target="cardsCodeContainer" onclick="copyCodeById(event)">Copy code</button>
  </div>
</header>

<div class="grid" id="cardsGrid">
  <!-- Card 1: Longest editor idle -->
  <div class="card" id="card-idle">
    <h3>Longest Editor Idle Time</h3>
    <div class="muted">Editors who haven’t updated pages recently</div>
    <ul class="small-list" id="idleList"><li class="muted">loading...</li></ul>
  </div>

  <!-- Card 2: Pages without priority -->
  <div class="card" id="card-no-priority">
    <h3>Pages Missing Priority</h3>
    <div class="muted">Pages without a set priority value</div>
    <ul class="small-list" id="noPriorityList"><li class="muted">loading...</li></ul>
  </div>

  <!-- Card 3: Divisions with highest QA flags -->
  <div class="card" id="card-qa-hotspots">
    <h3>QA Hotspots by Division</h3>
    <div class="muted">Divisions with highest QA flags per page</div>
    <ul class="small-list" id="qaHotspotList"><li class="muted">loading...</li></ul>
  </div>

  <!-- Card 4: Stale & Do Not Migrate pages -->
  <div class="card" id="card-stale-dnm">
    <h3>Stale & Do Not Migrate Pages</h3>
    <div class="muted">Old pages that are also marked "Do Not Migrate"</div>
    <ul class="small-list" id="staleDnmList"><li class="muted">loading...</li></ul>
  </div>

  <!-- Card 5: Redirect conflicts -->
  <div class="card" id="card-redirect-conflicts">
    <h3>Redirect Conflicts</h3>
    <div class="muted">Pages with conflicting internal/external redirects</div>
    <ul class="small-list" id="redirectConflictList"><li class="muted">loading...</li></ul>
  </div>

  <!-- Card 6: Quick win potential by division -->
  <div class="card" id="card-quick-wins">
    <h3>Quick Win Potential</h3>
    <div class="muted">High priority + low effort pages by division</div>
    <ul class="small-list" id="quickWinsList"><li class="muted">loading...</li></ul>
  </div>
</div>


<hr style="margin:20px 0;border:none;border-top:1px solid rgba(255,255,255,0.05)">
<div id="cardsCodeContainer" style="display:none;">
  /* Copy code container */
</div>
<div class="muted" id="refreshTime">Last refreshed: loading...</div>


<script>
/* ========= configuration ========= */
/* ========= configuration ========= */
const DATA_URL = 'https://cdn.jsdelivr.net/gh/ussthq-web-coordinator/USSTHQ-1@latest/DashboardData.json';
document.getElementById('dataUrl').textContent = DATA_URL;

/* ========= global storage ========= */
let allRows = [];      // full dataset
let refreshDate = '';  // last refresh time

/* ========= utility helpers ========= */
function parseDate(s){
  if(!s) return null;
  const d = new Date(s);
  return isNaN(d) ? null : d;
}
function daysSince(d){ return d ? Math.floor((Date.now() - d.getTime()) / (1000*60*60*24)) : null; }
function safeGet(row, key){ return row && (key in row) ? row[key] : ""; }

/* ========= fetch + render pipeline ========= */
async function fetchAndRender(){
  try {
    const res = await fetch(DATA_URL);
    const jsonData = await res.json();
    allRows = jsonData.data || [];
    refreshDate = jsonData.refreshDate || '';
    
    // update refresh time display
    const refreshEl = document.getElementById('refreshTime');
    if(refreshEl) refreshEl.textContent = 'Last refreshed: ' + refreshDate;

    renderObscureInsights(allRows);
    populateDivisionFilter(allRows);
  } catch(err){
    console.error('Failed to fetch data', err);
    alert('Could not fetch the dataset. Check URL / CORS in your environment.');
  }
}

/* ========= render and helper functions ========= */
function renderObscureInsights(rows){
  // 1: Longest editor idle
  const editorsLastUpdate = {};
  rows.forEach(r=>{
    const e = safeGet(r,'Page Editor')||'(unassigned)';
    const d = parseDate(safeGet(r,'Date Modified')||safeGet(r,'Date Publish'));
    if(!editorsLastUpdate[e] || d > editorsLastUpdate[e]) editorsLastUpdate[e] = d;
  });
  const idleList = document.getElementById('idleList');
  idleList.innerHTML = '';
  Object.entries(editorsLastUpdate)
    .sort((a,b)=> (a[1]?a[1].getTime():0) - (b[1]?b[1].getTime():0))
    .slice(0,10)
    .forEach(([editor,date])=>{
      const days = daysSince(date);
      const li = document.createElement('li');
      li.innerHTML = `<strong>${editor}</strong> · ${days} days since last update`;
      idleList.appendChild(li);
    });

  // 2: Pages missing priority
  const noPriorityPages = rows.filter(r=>!(safeGet(r,'Priority')||'').trim()).slice(0,12);
  const noPriorityList = document.getElementById('noPriorityList');
  noPriorityList.innerHTML = '';
  noPriorityPages.forEach(r=>{
    const li = document.createElement('li');
    li.innerHTML = `<strong>${safeGet(r,'Title')||safeGet(r,'Page Title')||'Untitled'}</strong> · ${safeGet(r,'Division')||'–'}`;
    noPriorityList.appendChild(li);
  });

  // 3: QA hotspots
  const qaByDivision = {};
  rows.forEach(r=>{
    const d = safeGet(r,'Division')||'(none)';
    const qaCount = (safeGet(r,'QA Issues.lookupValue')||'').trim() ? 1 : 0;
    if(!qaByDivision[d]) qaByDivision[d]=0;
    qaByDivision[d]+=qaCount;
  });
  const qaHotspotList = document.getElementById('qaHotspotList');
  qaHotspotList.innerHTML = '';
  Object.entries(qaByDivision)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,10)
    .forEach(([div,count])=>{
      const li = document.createElement('li');
      li.innerHTML = `<strong>${div}</strong> · ${count} QA flags`;
      qaHotspotList.appendChild(li);
    });

  // 4: Stale & Do Not Migrate
  const staleDnm = rows.filter(r=>{
    return (safeGet(r,'Status')==='Do Not Migrate') && parseDate(safeGet(r,'Date Modified')||safeGet(r,'Date Publish'));
  }).sort((a,b)=>daysSince(parseDate(safeGet(b,'Date Modified')||safeGet(b,'Date Publish')))-daysSince(parseDate(safeGet(a,'Date Modified')||safeGet(a,'Date Publish'))))
    .slice(0,12);
  const staleDnmList = document.getElementById('staleDnmList');
  staleDnmList.innerHTML = '';
  staleDnm.forEach(r=>{
    const li = document.createElement('li');
    const days = daysSince(parseDate(safeGet(r,'Date Modified')||safeGet(r,'Date Publish')));
    li.innerHTML = `<strong>${safeGet(r,'Title')||safeGet(r,'Page Title')||'Untitled'}</strong> · ${days} days old`;
    staleDnmList.appendChild(li);
  });

  // 5: Redirect conflicts
  const redirectConflicts = rows.filter(r=>{
    const redirect = (safeGet(r,'Redirect External URL')||'').trim();
    const zestyFull = (safeGet(r,'Zesty Full Page Path')||'').trim();
    return redirect && zestyFull;
  }).slice(0,12);
  const redirectConflictList = document.getElementById('redirectConflictList');
  redirectConflictList.innerHTML = '';
  redirectConflicts.forEach(r=>{
    const li = document.createElement('li');
    li.innerHTML = `<strong>${safeGet(r,'Title')||'Untitled'}</strong> · Redirect + Zesty path conflict`;
    redirectConflictList.appendChild(li);
  });

  // 6: Quick win potential
  const quickWins = rows.filter(r=>(safeGet(r,'Priority')==='High' && safeGet(r,'Effort Needed')==='Low'));
  const winsByDiv = {};
  quickWins.forEach(r=>{
    const d = safeGet(r,'Division')||'(none)';
    winsByDiv[d] = (winsByDiv[d]||0)+1;
  });
  const quickWinsList = document.getElementById('quickWinsList');
  quickWinsList.innerHTML = '';
  Object.entries(winsByDiv).sort((a,b)=>b[1]-a[1]).forEach(([div,count])=>{
    const li = document.createElement('li');
    li.innerHTML = `<strong>${div}</strong> · ${count} potential quick wins`;
    quickWinsList.appendChild(li);
  });
}


/* ========= populate division filter ========= */
function populateDivisionFilter(rows){
  const sel = document.getElementById('divisionFilter');
  sel.innerHTML = '<option value="">All Divisions</option>';
  Object.keys(window.__divCounts || {}).sort().forEach(d=>{
    const opt = document.createElement('option');
    opt.value = d;
    opt.textContent = `${d} (${window.__divCounts[d]})`;
    sel.appendChild(opt);
  });

  sel.onchange = () => {
    const val = sel.value;
    if(!val) return renderAll(allRows);
    const filtered = allRows.filter(r => (safeGet(r,'Division')||'')===val);
    renderAll(filtered);
  };
}

/* ========= UI helpers ========= */
document.getElementById('refreshBtn').addEventListener('click', ()=>fetchAndRender());
document.getElementById('toggleCodeBtn').addEventListener('click', ()=>{
  const el = document.getElementById('cardsCodeContainer');
  el.style.display = el.style.display==='none'?'block':'none';
  document.getElementById('toggleCodeBtn').textContent = el.style.display==='none'?'Show code':'Hide code';
});
function copyCodeById(evt){
  const targetId = evt?.target?.dataset?.copyTarget;
  if(!targetId){ alert('No data-copy-target'); return; }
  const el = document.getElementById(targetId);
  if(!el){ alert('Target element not found'); return; }
  const text = el.textContent || el.innerText || el.innerHTML;
  navigator.clipboard.writeText(text).then(()=>{
    const original = evt.target.textContent;
    evt.target.textContent = 'Copied!';
    setTimeout(()=> evt.target.textContent = original,1200);
  }).catch(err=>alert('Copy failed: '+err));
}

/* ========= boot ========= */
fetchAndRender();

/* ========= end ========= */
</script>
</body>
</html>
